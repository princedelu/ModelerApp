/*! ModelerApp 07-05-2014 */
angular.module("underscore",[]).factory("_",function(){return window._}),angular.module("ModelerApp",["ngCookies","ngRoute","underscore","ui.bootstrap"]).config(["$routeProvider","$locationProvider","$httpProvider",function($routeProvider,$locationProvider,$httpProvider){var access=routingConfig.accessLevels;$routeProvider.when("/",{templateUrl:"/accueil/partials/public.jade",controller:"LoginCtrl",access:access.anon}),$routeProvider.when("/home",{templateUrl:"/accueil/partials/home.jade",controller:"LoginCtrl",access:access.user}),$routeProvider.when("/element",{templateUrl:"/element/partials/home.jade",controller:"dynamicCtrl",access:access.user}),$routeProvider.when("/restitution",{templateUrl:"/restit/partials/home.jade",controller:"GroupCtrl",action:"home",resolve:{grappeElement:function(){return""}},access:access.user}),$routeProvider.when("/:objet/list",{templateUrl:"/element/partials/list.jade",controller:"dynamicCtrl",action:"list",access:access.user}),$routeProvider.when("/:objet/add",{templateUrl:function(params){return"/element/partials/"+params.objet+"/get.jade"},controller:"dynamicCtrl",action:"add",access:access.user}),$routeProvider.when("/:objet/item/:id",{templateUrl:function(params){return"/element/partials/"+params.objet+"/get.jade"},controller:"dynamicCtrl",action:"get",access:access.user}),$routeProvider.when("/group/:element",{templateUrl:function(){return"/restit/partials/group/get.jade"},controller:"GroupCtrl",action:"get",resolve:{grappeElement:function($route,$q,Group){var deferred=$q.defer();return Group.get($route.current.params.element,function(res){deferred.resolve(res)},function(){deferred.reject()}),deferred.promise}},access:access.user}),$routeProvider.when("/404",{templateUrl:"/partials/404.jade",access:access.public}),$routeProvider.otherwise({redirectTo:"/404"}),$locationProvider.html5Mode(!0),$httpProvider.interceptors.push(function($q,$location){return{responseError:function(response){return 401===response.status||403===response.status?($location.path("/"),$q.reject(response)):$q.reject(response)}}})}]).run(["$rootScope","$location","Auth",function($rootScope,$location,Auth){$rootScope.modelConfig=modelConfig.modelConfig,$rootScope.$on("$routeChangeStart",function(event,next){$rootScope.error=null,Auth.authorize(next.access)||$location.path(Auth.isLoggedIn()?"/home":"/")})}]),$(document).ready(function(){$("label.tree-toggler").click(function(){$(this).parent().children("ul.tree").toggle(200)})}),function(){"use strict";angular.module("ModelerApp").factory("Auth",["$http","$cookieStore",function($http,$cookieStore){function changeUser(user){_.extend(currentUser,user)}var accessLevels=routingConfig.accessLevels,userRoles=routingConfig.userRoles,currentUser=$cookieStore.get("user")||{username:"",role:userRoles.public};return $cookieStore.remove("user"),{authorize:function(accessLevel,role){return void 0===accessLevel&&(accessLevel=userRoles.admin),void 0===role&&(role=currentUser.role),accessLevel.bitMask&role.bitMask},isLoggedIn:function(user){return void 0===user&&(user=currentUser),user.role.title==userRoles.user.title||user.role.title==userRoles.admin.title},login:function(user,success,error){$http.post("/api/login",user).success(function(user){changeUser(user),success(user)}).error(error)},logout:function(success,error){$http.post("/api/logout").success(function(){changeUser({username:"",role:userRoles.public}),success()}).error(error)},accessLevels:accessLevels,userRoles:userRoles,user:currentUser}}])}(),function(){"use strict";angular.module("ModelerApp").factory("Objet",["$http",function($http){var userRoles=routingConfig.userRoles;return{list:function(nomObjet,success,error){$http.get("/api/"+nomObjet).success(success).error(error)},add:function(nomObjet,objet,success,error){$http.post("/api/"+nomObjet,objet).success(success).error(error)},get:function(nomObjet,id,success,error){$http.get("/api/"+nomObjet+"/"+id).success(success).error(error)},"delete":function(nomObjet,id,success,error){$http.delete("/api/"+nomObjet+"/"+id).success(success).error(error)},put:function(nomObjet,objet,success,error){$http.put("/api/"+nomObjet,objet).success(success).error(error)},userRoles:userRoles}}])}(),function(){"use strict";angular.module("ModelerApp").factory("Group",["$http",function($http){var userRoles=routingConfig.userRoles;return{get:function(nomGroup,success,error){$http.get("/api/group-"+nomGroup).success(success).error(error)},userRoles:userRoles}}])}(),function(){"use strict";angular.module("ModelerApp").controller("LoginCtrl",["$rootScope","$scope","$location","$window","Auth",function($rootScope,$scope,$location,$window,Auth){$scope.user=Auth.user,$scope.userRoles=Auth.userRoles,$scope.accessLevels=Auth.accessLevels,$scope.rememberme=!0,$scope.login=function(){Auth.login({username:$scope.username,password:$scope.password,rememberme:$scope.rememberme},function(){$location.path("/home")},function(){$scope.error="Failed to login"})},$scope.logout=function(){Auth.logout(function(){$location.path("/")},function(){$scope.error="Failed to logout"})}}])}(),function(){"use strict";angular.module("ModelerApp").controller("LoginCtrl",["$rootScope","$scope","$location","$route","$window","Auth",function($rootScope,$scope,$location,$route,$window,Auth){$scope.user=Auth.user,$scope.userRoles=Auth.userRoles,$scope.accessLevels=Auth.accessLevels,$scope.rememberme=!0,$scope.login=function(){Auth.login({username:$scope.username,password:$scope.password,rememberme:$scope.rememberme},function(){$location.path("/home")},function(){$scope.error="Failed to login"})},$scope.logout=function(){Auth.logout(function(){$location.path("/")},function(){$scope.error="Failed to logout"})},$scope.isModuleElement=!1,$scope.isModuleRestit=!1,"/element/"==$location.path()&&($scope.isModuleElement=!0),"/restitution"==$location.path()&&($scope.isModuleRestit=!0)}])}(),function(){"use strict";angular.module("ModelerApp").controller("dynamicCtrl",["$rootScope","$scope","$location","$route","$routeParams","Objet","_","Auth",function($rootScope,$scope,$location,$route,$routeParams,Objet,_,Auth){$scope.isModuleElement=!0;var nomObjet=$routeParams.objet,action=$route.current.action;$scope.action=action,$scope.accordionCloseOther=modelConfig.modelConfig.config.accordionCloseOther,$scope.isOpenAccordion=modelConfig.modelConfig.config.isOpenAccordion,$scope.typeElements=modelConfig.modelConfig.models.typeElements;var elementConfig;switch(_.each(modelConfig.modelConfig.models.index,function(item){modelConfig.modelConfig.models[item.nom].model==nomObjet&&(elementConfig=modelConfig.modelConfig.models[item.nom])}),$scope.elementConfig=elementConfig,$scope.user=Auth.user,$scope.userRoles=Auth.userRoles,$scope.accessLevels=Auth.accessLevels,$scope.list=function(){$scope.success="",$scope.error="",Objet.list(nomObjet,function(res){$scope.objets=res,$scope.loading=!1},function(){$scope.error="Failed to fetch "+nomObjet,$scope.loading=!1})},$scope.add=function(){if($scope.success="",$scope.error="","get"==action)$scope.update();else{var objetValue={};_.each(elementConfig.champs,function(item){var modelChamp=item.model;"_id"!=modelChamp&&(objetValue[modelChamp]=$scope[modelChamp])}),Objet.add(nomObjet,objetValue,function(){$scope.success="Succes",$location.path("/"+nomObjet+"/list")},function(err){$scope.error=err,"Doublon"==err&&($scope.doublon="true"),$location.path("/"+nomObjet+"/add")})}},$scope.update=function(){$scope.success="",$scope.error="";var objetValue={};_.each(elementConfig.champs,function(item){var modelChamp=item.model;objetValue[modelChamp]=$scope[modelChamp]}),Objet.put(nomObjet,objetValue,function(){$scope.success="Succes",$location.path("/"+nomObjet+"/list")},function(err){$scope.error=err,"Doublon"==err&&($scope.doublon="true"),$location.path("/"+nomObjet+"/item/"+$routeParams.id)})},$scope.delete=function(id){$scope.success="",$scope.error="",Objet.delete(nomObjet,id,function(){$scope.success="Succes",$route.reload()},function(err){$scope.error=err,$route.reload()})},$scope.go=function(path){$location.path(path)},$scope.get=function(id){$scope.success="",$scope.error="",Objet.get(nomObjet,id,function(res){_.each(elementConfig.champs,function(item){var modelChamp=item.model;$scope[modelChamp]=res[modelChamp]}),$scope.loading=!1},function(){$scope.error="Failed to fetch "+nomObjet,$scope.loading=!1})},$scope.loadListe=function(){$scope.success="",$scope.error="",_.each(elementConfig.populate,function(item){var modelPopulate=item.model;Objet.list(modelPopulate,function(res){$scope[modelPopulate+"s"]=res,$scope.loading=!1},function(){$scope.error="Failed to fetch "+modelPopulate,$scope.loading=!1})})},$scope.disabled=function(date,mode){return"day"===mode&&(0===date.getDay()||6===date.getDay())},$scope.open=function($event){$event.preventDefault(),$event.stopPropagation(),$scope.opened=!0},action){case"list":$scope.list();break;case"get":var id=$routeParams.id;$scope.loadListe(),$scope.get(id);break;case"add":$scope.loadListe()}}])}(),function(){"use strict";angular.module("ModelerApp").controller("GroupCtrl",["$route","$scope","$routeParams","grappeElement","Group",function($route,$scope,$routeParams,grappeElement){$scope.isModuleRestit=!0;var action=$route.current.action;switch($scope.get=function(){$routeParams.element;$scope.success="",$scope.error="",$scope.grappeElement=grappeElement},action){case"get":$scope.get()}}])}(),function(){"use strict";angular.module("ModelerApp").directive("accessLevel",["Auth",function(Auth){return{restrict:"A",link:function($scope,element,attrs){function updateCSS(){userRole&&accessLevel&&(Auth.authorize(accessLevel,userRole)?element.css("display",prevDisp):element.css("display","none"))}var userRole,accessLevel,prevDisp=element.css("display");$scope.user=Auth.user,$scope.$watch("user",function(user){user.role&&(userRole=user.role),updateCSS()},!0),attrs.$observe("accessLevel",function(al){al&&(accessLevel=$scope.$eval(al)),updateCSS()})}}}]),angular.module("ModelerApp").directive("activeNav",["$location",function($location){return{restrict:"A",link:function(scope,element){var nestedA=element.find("a")[0],path=nestedA.href;scope.location=$location,scope.$watch("location.absUrl()",function(newPath){path===newPath?element.addClass("active"):element.removeClass("active")})}}}])}(),function(){"use strict";angular.module("ModelerApp").directive("jstree",["$rootScope","$location",function($rootScope,$location){return{restrict:"A",link:function(scope,element,attrs){function customMenu(node){var id=node.id;id=id.substring(6,id.length+1);var items={addItem:{label:"Ajout",action:function(){$rootScope.$apply(function(){$location.path("/"+id+"/add")})}},listItem:{label:"Liste",action:function(){$rootScope.$apply(function(){$location.path("/"+id+"/list")})}}};return $(node).hasClass("folder")&&delete items.deleteItem,items}$(function(){var tree=$(element[0]).jstree({core:{data:function(obj,cb){var listeValeurArbre=[],nbValeur=0,jstreeType=attrs.jstreeType;_.each(modelConfig.modelConfig.models.index,function(item){if(item.type===jstreeType){var valeurArbre={};valeurArbre.id="idtree"+modelConfig.modelConfig.models[item.nom].model,valeurArbre.parent="#",valeurArbre.text=item.nom,listeValeurArbre[nbValeur]=valeurArbre,nbValeur++}}),cb.call(this,listeValeurArbre)}},plugins:["contextmenu"],contextmenu:{items:customMenu}});tree.on("select_node.jstree",function(e,data){var id=data.node.id;id=id.substring(6,id.length+1),$rootScope.$apply(function(){$location.path("/"+id+"/list")})})})}}}])}(),function(){"use strict";angular.module("ModelerApp").directive("jstreerestit",["$rootScope","$location",function($rootScope,$location){return{restrict:"A",link:function(scope,element){function customMenu(node){var id=node.id;id=id.substring(12,id.length+1);var items={getItem:{label:"Afficher",action:function(){$rootScope.$apply(function(){$location.path("/group/"+id)})}}};return $(node).hasClass("folder")&&delete items.deleteItem,items}$(function(){$(element[0]).jstree({core:{data:function(obj,cb){for(var listeValeurArbre=[],id=0;id<modelConfig.modelConfig.groups.index.length;id++){var valeurArbre={};valeurArbre.id="idtreeRestit"+modelConfig.modelConfig.groups.index[id].nom,valeurArbre.parent="#",valeurArbre.text=modelConfig.modelConfig.groups.index[id].nom.charAt(0).toUpperCase()+modelConfig.modelConfig.groups.index[id].nom.slice(1).toLowerCase(),listeValeurArbre[id]=valeurArbre}cb.call(this,listeValeurArbre)}},plugins:["contextmenu"],contextmenu:{items:customMenu}})})}}}]),angular.module("ModelerApp").directive("d3TreeMap",["$rootScope","$location",function(){return{restrict:"E",replace:!1,scope:{data:"=data"},link:function(scope,element){var chart=d3.select(element[0]),width=960,height=500,color=d3.scale.category20c(),treemap=d3.layout.treemap().size([width,height]).padding(16).value(function(d){return d.size}),div=chart.append("div").style("position","relative").style("width",width+"px").style("height",height+"px");div.selectAll(".node").data(treemap.nodes(scope.data)).enter().append("div").attr("class","node").style("left",function(d){return d.x+"px"}).style("top",function(d){return d.y+"px"}).style("width",function(d){return Math.max(0,d.dx-1)+"px"}).style("height",function(d){return Math.max(0,d.dy-1)+"px"}).style("background",function(d){return d.children?color(d.name):null}).text(function(d){return d.children?d.name:d.name})}}}])}();