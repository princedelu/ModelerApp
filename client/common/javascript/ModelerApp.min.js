/*! ModelerApp 03-05-2014 */
angular.module("underscore",[]).factory("_",function(){return window._}),angular.module("ModelerApp",["ngCookies","ngRoute","underscore"]).config(["$routeProvider","$locationProvider","$httpProvider",function(a,b,c){var d=routingConfig.accessLevels;a.when("/",{templateUrl:"/accueil/partials/public.jade",controller:"LoginCtrl",access:d.anon}),a.when("/home",{templateUrl:"/accueil/partials/home.jade",controller:"LoginCtrl",access:d.user}),a.when("/element",{templateUrl:"/element/partials/home.jade",controller:"dynamicCtrl",access:d.user}),a.when("/restitution",{templateUrl:"/restit/partials/home.jade",controller:"GroupCtrl",action:"home",resolve:{grappeElement:function(){return""}},access:d.user}),a.when("/:objet/list",{templateUrl:"/element/partials/list.jade",controller:"dynamicCtrl",action:"list",access:d.user}),a.when("/:objet/add",{templateUrl:function(a){return"/element/partials/"+a.objet+"/get.jade"},controller:"dynamicCtrl",action:"add",access:d.user}),a.when("/:objet/item/:id",{templateUrl:function(a){return"/element/partials/"+a.objet+"/get.jade"},controller:"dynamicCtrl",action:"get",access:d.user}),a.when("/group/:element",{templateUrl:function(){return"/restit/partials/group/get.jade"},controller:"GroupCtrl",action:"get",resolve:{grappeElement:function(a,b,c){var d=b.defer();return c.get(a.current.params.element,function(a){d.resolve(a)},function(){d.reject()}),d.promise}},access:d.user}),a.when("/404",{templateUrl:"/partials/404.jade",access:d.public}),a.otherwise({redirectTo:"/404"}),b.html5Mode(!0),c.interceptors.push(function(a,b){return{responseError:function(c){return 401===c.status||403===c.status?(b.path("/"),a.reject(c)):a.reject(c)}}})}]).run(["$rootScope","$location","Auth",function(a,b,c){a.modelConfig=modelConfig.modelConfig,a.$on("$routeChangeStart",function(d,e){a.error=null,c.authorize(e.access)||b.path(c.isLoggedIn()?"/home":"/")})}]),$(document).ready(function(){$("label.tree-toggler").click(function(){$(this).parent().children("ul.tree").toggle(200)})}),function(){"use strict";angular.module("ModelerApp").factory("Auth",function(a,b){function c(a){_.extend(f,a)}var d=routingConfig.accessLevels,e=routingConfig.userRoles,f=b.get("user")||{username:"",role:e.public};return b.remove("user"),{authorize:function(a,b){return void 0===b&&(b=f.role),a.bitMask&b.bitMask},isLoggedIn:function(a){return void 0===a&&(a=f),a.role.title==e.user.title||a.role.title==e.admin.title},login:function(b,d,e){a.post("/api/login",b).success(function(a){c(a),d(a)}).error(e)},logout:function(b,d){a.post("/api/logout").success(function(){c({username:"",role:e.public}),b()}).error(d)},accessLevels:d,userRoles:e,user:f}})}(),function(){"use strict";angular.module("ModelerApp").factory("Auth",function(a,b){function c(a){_.extend(f,a)}var d=routingConfig.accessLevels,e=routingConfig.userRoles,f=b.get("user")||{username:"",role:e.public};return b.remove("user"),{authorize:function(a,b){return void 0===a&&(a=e.user),void 0===b&&(b=f.role),a.bitMask&b.bitMask},isLoggedIn:function(a){return void 0===a&&(a=f),a.role.title==e.user.title||a.role.title==e.admin.title},login:function(b,d,e){a.post("/api/login",b).success(function(a){c(a),d(a)}).error(e)},logout:function(b,d){a.post("/api/logout").success(function(){c({username:"",role:e.public}),b()}).error(d)},accessLevels:d,userRoles:e,user:f}})}(),function(){"use strict";angular.module("ModelerApp").factory("Objet",function(a){var b=routingConfig.userRoles;return{list:function(b,c,d){a.get("/api/"+b).success(c).error(d)},add:function(b,c,d,e){a.post("/api/"+b,c).success(d).error(e)},get:function(b,c,d,e){a.get("/api/"+b+"/"+c).success(d).error(e)},"delete":function(b,c,d,e){a.delete("/api/"+b+"/"+c).success(d).error(e)},put:function(b,c,d,e){a.put("/api/"+b,c).success(d).error(e)},userRoles:b}})}(),function(){"use strict";angular.module("ModelerApp").factory("Group",function(a){var b=routingConfig.userRoles;return{get:function(b,c,d){a.get("/api/group-"+b).success(c).error(d)},userRoles:b}})}(),function(){"use strict";angular.module("ModelerApp").controller("LoginCtrl",["$rootScope","$scope","$location","$window","Auth",function(a,b,c,d,e){b.user=e.user,b.userRoles=e.userRoles,b.accessLevels=e.accessLevels,b.rememberme=!0,b.login=function(){e.login({username:b.username,password:b.password,rememberme:b.rememberme},function(){c.path("/home")},function(){b.error="Failed to login"})},b.logout=function(){e.logout(function(){c.path("/")},function(){b.error="Failed to logout"})}}])}(),function(){"use strict";angular.module("ModelerApp").controller("LoginCtrl",["$rootScope","$scope","$location","$route","$window","Auth",function(a,b,c,d,e,f){b.user=f.user,b.userRoles=f.userRoles,b.accessLevels=f.accessLevels,b.rememberme=!0,b.login=function(){f.login({username:b.username,password:b.password,rememberme:b.rememberme},function(){c.path("/home")},function(){b.error="Failed to login"})},b.logout=function(){f.logout(function(){c.path("/")},function(){b.error="Failed to logout"})},b.isModuleElement=!1,b.isModuleRestit=!1,"/element/"==c.path()&&(b.isModuleElement=!0),"/restitution"==c.path()&&(b.isModuleRestit=!0)}])}(),function(){"use strict";angular.module("ModelerApp").controller("dynamicCtrl",["$rootScope","$scope","$location","$route","$routeParams","Objet","_",function(a,b,c,d,e,f,g){b.isModuleElement=!0;var h=e.objet,i=d.current.action;b.action=i;var j;switch(g.each(modelConfig.modelConfig.models,function(a){a.model==h&&(j=a)}),b.elementConfig=j,b.list=function(){b.success="",b.error="",f.list(h,function(a){b.objets=a,b.loading=!1},function(){b.error="Failed to fetch "+h,b.loading=!1})},b.add=function(){if(b.success="",b.error="","get"==i)b.update();else{for(var a={},d=0;d<j.champs.length;d++){var e=j.champs[d].model;"_id"!=e&&(a[e]=b[e])}f.add(h,a,function(){b.success="Succes",c.path("/"+h+"/list")},function(a){b.error=a,"Doublon"==a&&(b.doublon="true"),c.path("/"+h+"/add")})}},b.update=function(){b.success="",b.error="";for(var a={},d=0;d<j.champs.length;d++){var g=j.champs[d].model;a[g]=b[g]}f.put(h,a,function(){b.success="Succes",c.path("/"+h+"/list")},function(a){b.error=a,"Doublon"==a&&(b.doublon="true"),c.path("/"+h+"/item/"+e.id)})},b.delete=function(a){b.success="",b.error="",f.delete(h,a,function(){b.success="Succes",d.reload()},function(a){b.error=a,d.reload()})},b.get=function(a){b.success="",b.error="",f.get(h,a,function(a){for(var c=0;c<j.champs.length;c++){var d=j.champs[c].model;b[d]=a[d]}b.loading=!1},function(){b.error="Failed to fetch "+h,b.loading=!1})},b.loadListe=function(){b.success="",b.error="",g.each(j.populate,function(a){var c=a.model;f.list(c,function(a){b[c+"s"]=a,b.loading=!1},function(){b.error="Failed to fetch "+c,b.loading=!1})})},i){case"list":b.list();break;case"get":var k=e.id;b.loadListe(),b.get(k);break;case"add":b.loadListe()}}])}(),function(){"use strict";angular.module("ModelerApp").controller("GroupCtrl",["$route","$scope","$routeParams","grappeElement","Group",function(a,b,c,d){b.isModuleRestit=!0;var e=a.current.action;switch(b.get=function(){c.element;b.success="",b.error="",b.grappeElement=d},e){case"get":b.get()}}])}(),function(){"use strict";angular.module("ModelerApp").directive("accessLevel",["Auth",function(a){return{restrict:"A",link:function(b,c,d){function e(){f&&g&&(a.authorize(g,f)?c.css("display",h):c.css("display","none"))}var f,g,h=c.css("display");b.user=a.user,b.$watch("user",function(a){a.role&&(f=a.role),e()},!0),d.$observe("accessLevel",function(a){a&&(g=b.$eval(a)),e()})}}}]),angular.module("ModelerApp").directive("activeNav",["$location",function(a){return{restrict:"A",link:function(b,c){var d=c.find("a")[0],e=d.href;b.location=a,b.$watch("location.absUrl()",function(a){e===a?c.addClass("active"):c.removeClass("active")})}}}])}(),function(){"use strict";angular.module("ModelerApp").directive("jstree",["$rootScope","$location",function(a,b){return{restrict:"A",link:function(c,d){function e(c){var d=c.id;d=d.substring(6,d.length+1);var e={addItem:{label:"Ajout",action:function(){a.$apply(function(){b.path("/"+d+"/add")})}},listItem:{label:"Liste",action:function(){a.$apply(function(){b.path("/"+d+"/list")})}}};return $(c).hasClass("folder")&&delete e.deleteItem,e}$(function(){$(d[0]).jstree({core:{data:function(a,b){for(var c=[],d=0;d<modelConfig.modelConfig.models.length;d++){var e={};e.id="idtree"+modelConfig.modelConfig.models[d].model,e.parent="#",e.text=modelConfig.modelConfig.models[d].nom,c[d]=e}b.call(this,c)}},plugins:["contextmenu"],contextmenu:{items:e}})})}}}])}(),function(){"use strict";angular.module("ModelerApp").directive("jstreerestit",["$rootScope","$location",function(a,b){return{restrict:"A",link:function(c,d){function e(c){var d=c.id;d=d.substring(12,d.length+1);var e={getItem:{label:"Afficher",action:function(){a.$apply(function(){b.path("/group/"+d)})}}};return $(c).hasClass("folder")&&delete e.deleteItem,e}$(function(){$(d[0]).jstree({core:{data:function(a,b){for(var c=[],d=0;d<modelConfig.modelConfig.groups.index.length;d++){var e={};e.id="idtreeRestit"+modelConfig.modelConfig.groups.index[d].nom,e.parent="#",e.text=modelConfig.modelConfig.groups.index[d].nom.charAt(0).toUpperCase()+modelConfig.modelConfig.groups.index[d].nom.slice(1).toLowerCase(),c[d]=e}b.call(this,c)}},plugins:["contextmenu"],contextmenu:{items:e}})})}}}]),angular.module("ModelerApp").directive("d3TreeMap",["$rootScope","$location",function(){return{restrict:"E",replace:!1,scope:{data:"=data"},link:function(a,b){var c=d3.select(b[0]),d=960,e=500,f=d3.scale.category20c(),g=d3.layout.treemap().size([d,e]).padding(16).value(function(a){return a.size}),h=c.append("div").style("position","relative").style("width",d+"px").style("height",e+"px");h.selectAll(".node").data(g.nodes(a.data)).enter().append("div").attr("class","node").style("left",function(a){return a.x+"px"}).style("top",function(a){return a.y+"px"}).style("width",function(a){return Math.max(0,a.dx-1)+"px"}).style("height",function(a){return Math.max(0,a.dy-1)+"px"}).style("background",function(a){return a.children?f(a.name):null}).text(function(a){return a.children?a.name:a.name})}}}])}();